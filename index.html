<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vest – kart</title>

  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

  <!-- Geocoder -->
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.1/mapbox-gl-geocoder.css" />
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.1/mapbox-gl-geocoder.min.js" defer></script>

  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    #map { width: 100%; height: 100vh; }

    #search {
      position: fixed;
      top: 12px;
      left: 12px;
      z-index: 9999;
      width: min(380px, calc(100vw - 24px));
    }
    #search .mapboxgl-ctrl-geocoder {
      min-width: 100%;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.12);
    }

    .mapboxgl-popup-content {
      background: #ffffff;
      border-radius: 12px;
      padding: 12px 14px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    }
    .popup-title {
      font-size: 15px;
      font-weight: 700;
      color: #6F3A8A;
      line-height: 1.2;
    }
    .popup-sub {
      font-size: 12px;
      color: #6B7280;
      margin-top: 3px;
    }
    .mapboxgl-popup-tip { border-top-color: #ffffff !important; }
  </style>
</head>

<body>
  <div id="search"></div>
  <div id="map"></div>

  <script>
    mapboxgl.accessToken = "pk.eyJ1IjoiaGFhbm5uZWVlZSIsImEiOiJjbWE0Nnp4OWwwM3NxMmlxejNudXBwa2I3In0.EzmmIDuSMF5JupYeej9NoA";

    const STYLE_URL = "mapbox://styles/mapbox/streets-v12";
    const GEOJSON_URL = "./klesbokser_clean_stripped.geojson";

    // ⚠️ VIKTIG: må matche filnavn 100% (store/små bokstaver)
    const ICON_URL = "./Fileks_logosymbol_128.png";

    const NAME_PROP = null;

    const MIN_ZOOM = 5;
    const MAX_ZOOM = 16;

    const POINTS_MIN_ZOOM = 14;
    const POINTS_SHOW_ZOOM = POINTS_MIN_ZOOM - 1; // 13

    const IS_MOBILE = window.matchMedia("(pointer: coarse)").matches || window.innerWidth < 768;

    function showError(msg) {
      let el = document.getElementById("map-error");
      if (!el) {
        el = document.createElement("div");
        el.id = "map-error";
        el.style.cssText = `
          position: fixed; left: 12px; bottom: 12px; z-index: 9999;
          background: rgba(17,24,39,.92); color: #fff; padding: 10px 12px;
          border-radius: 10px; font: 12px/1.4 system-ui, sans-serif; max-width: 520px;
        `;
        document.body.appendChild(el);
      }
      el.textContent = msg;
    }

    function isNorwayish(c) {
      if (!Array.isArray(c) || c.length < 2) return false;
      const [lng, lat] = c;
      return Number.isFinite(lng) && Number.isFinite(lat)
        && lng >= 4 && lng <= 32
        && lat >= 57 && lat <= 72;
    }

    const map = new mapboxgl.Map({
      container: "map",
      style: STYLE_URL,
      center: [10.75, 59.91],
      zoom: 5,
      minZoom: MIN_ZOOM,
      maxZoom: MAX_ZOOM
    });

    map.addControl(new mapboxgl.NavigationControl({ showCompass: true }), "top-right");

    map.on("error", (e) => {
      const err = e && e.error ? e.error : e;
      console.error("Map error:", err);
      showError("Mapbox-feil: " + (err && err.message ? err.message : String(err)));
    });

    map.on("load", async () => {
      // ✅ Geocoder init her inne (sikkert at Mapbox GL er klar)
      try {
        if (typeof MapboxGeocoder !== "undefined") {
          const geocoder = new MapboxGeocoder({
            accessToken: mapboxgl.accessToken,
            mapboxgl,
            marker: false,
            countries: "no",
            language: "no",
            placeholder: "Søk etter sted eller adresse i Norge",
            zoom: 14
          });
          document.getElementById("search").appendChild(geocoder.onAdd(map));
        } else {
          console.warn("MapboxGeocoder er undefined – plugin lastet ikke.");
        }
      } catch (e) {
        console.warn("Geocoder feilet, men kartet fortsetter:", e);
      }

      let geo;

      // 1) GeoJSON
      try {
        const r = await fetch(GEOJSON_URL);
        if (!r.ok) throw new Error(`GeoJSON HTTP ${r.status} (${r.statusText})`);
        geo = await r.json();
      } catch (err) {
        console.error(err);
        showError("Klarte ikke laste GeoJSON: " + err.message);
        return;
      }

      // 2) Source (clustering)
      map.addSource("utplasseringer", {
        type: "geojson",
        data: geo,
        cluster: true,
        clusterMaxZoom: POINTS_MIN_ZOOM,
        clusterRadius: IS_MOBILE ? 60 : 50
      });

      // 3) Legg ALLTID til cluster-lagene først (så “forsvinner ikke alt”)
      map.addLayer({
        id: "clusters",
        type: "circle",
        source: "utplasseringer",
        filter: ["has", "point_count"],
        maxzoom: POINTS_MIN_ZOOM,
        paint: {
          "circle-color": [
            "step",
            ["get", "point_count"],
            "#9c6bb3",
            10, "#6F3A8A",
            30, "#4B1F66"
          ],
          "circle-radius": [
            "step",
            ["get", "point_count"],
            18,
            10, 22,
            30, 28
          ],
          "circle-stroke-width": 0
        }
      });

      map.addLayer({
        id: "cluster-count",
        type: "symbol",
        source: "utplasseringer",
        filter: ["has", "point_count"],
        maxzoom: POINTS_MIN_ZOOM,
        layout: {
          "text-field": "{point_count_abbreviated}",
          "text-font": ["DIN Offc Pro Medium", "Arial Unicode MS Bold"],
          "text-size": 13
        },
        paint: { "text-color": "#ffffff" }
      });

      // 4) Fit bounds
      try {
        const b = new mapboxgl.LngLatBounds();
        (geo.features || []).forEach((f) => {
          const c = f?.geometry?.coordinates;
          if (isNorwayish(c)) b.extend(c);
        });

        if (!b.isEmpty()) {
          map.fitBounds(b, { padding: 60, maxZoom: 14, duration: 0 });
        }
      } catch (err) {
        console.warn("fitBounds-feil:", err);
      }

      // 5) Hit-area (alltid)
      map.addLayer({
        id: "unclustered-hit",
        type: "circle",
        source: "utplasseringer",
        filter: ["!", ["has", "point_count"]],
        minzoom: POINTS_SHOW_ZOOM,
        paint: {
          "circle-radius": [
            "interpolate",
            ["linear"],
            ["zoom"],
            14, IS_MOBILE ? 22 : 18,
            16, IS_MOBILE ? 28 : 22
          ],
          "circle-color": "#000",
          "circle-opacity": 0
        }
      });

      // 6) Prøv ikon – hvis det feiler, fall tilbake til sirkelpunkter
      let iconOk = false;
      try {
        await new Promise((resolve, reject) => {
          map.loadImage(ICON_URL, (err, image) => {
            if (err) return reject(err);
            if (!map.hasImage("fileks-icon")) {
              map.addImage("fileks-icon", image, { pixelRatio: 2 });
            }
            resolve();
          });
        });
        iconOk = true;
      } catch (err) {
        console.warn("Ikon lastet ikke (fortsetter med sirkelpunkter):", err);
        showError("Fant ikke ikon: sjekk filnavn/sti (bruker fallback).");
      }

      if (iconOk) {
        map.addLayer({
          id: "unclustered-point",
          type: "symbol",
          source: "utplasseringer",
          filter: ["!", ["has", "point_count"]],
          minzoom: POINTS_SHOW_ZOOM,
          layout: {
            "icon-image": "fileks-icon",
            "icon-size": ["interpolate", ["linear"], ["zoom"], 14, 0.6, 16, 0.8],
            "icon-allow-overlap": true,
            "icon-anchor": "bottom"
          }
        });
      } else {
        map.addLayer({
          id: "unclustered-point-fallback",
          type: "circle",
          source: "utplasseringer",
          filter: ["!", ["has", "point_count"]],
          minzoom: POINTS_SHOW_ZOOM,
          paint: {
            "circle-color": "#743492",
            "circle-radius": ["interpolate", ["linear"], ["zoom"], 14, 6, 16, 8],
            "circle-stroke-color": "#ffffff",
            "circle-stroke-width": 1.5
          }
        });
      }

      // Cluster click
      map.on("click", "clusters", (e) => {
        const features = map.queryRenderedFeatures(e.point, { layers: ["clusters"] });
        if (!features.length) return;

        const clusterId = features[0].properties.cluster_id;
        const source = map.getSource("utplasseringer");
        map.stop();

        source.getClusterLeaves(clusterId, 200, 0, (err, leaves) => {
          if (err || !leaves || !leaves.length) return;

          const b = new mapboxgl.LngLatBounds();
          let n = 0;

          for (const f of leaves) {
            const c = f?.geometry?.coordinates;
            if (!isNorwayish(c)) continue;
            b.extend(c);
            n++;
          }

          if (!n || b.isEmpty()) {
            map.easeTo({
              center: features[0].geometry.coordinates,
              zoom: Math.min(Math.max(map.getZoom() + 2, MIN_ZOOM), MAX_ZOOM),
              duration: 600
            });
            return;
          }

          map.fitBounds(b, { padding: 60, maxZoom: MAX_ZOOM, duration: 600 });
        });
      });

      map.on("mouseenter", "clusters", () => { if (!IS_MOBILE) map.getCanvas().style.cursor = "pointer"; });
      map.on("mouseleave", "clusters", () => { if (!IS_MOBILE) map.getCanvas().style.cursor = ""; });

      // Popup (hover desktop / tap mobil) via hit-layer
      let popup = null;

      function resolveLabel(props) {
        if (!props) return "";
        if (NAME_PROP && props[NAME_PROP] != null) return String(props[NAME_PROP]);
        const candidates = ["navn", "name", "title", "sted", "lokasjon", "adresse", "label"];
        for (const key of candidates) {
          const v = props[key];
          if (v != null && String(v).trim() !== "") return String(v);
        }
        return "";
      }

      function openPopupForFeature(f) {
        if (!f) return;
        const coords = f.geometry.coordinates.slice();
        const label = resolveLabel(f.properties);

        if (popup) popup.remove();

        const el = document.createElement("div");
        const t = document.createElement("div");
        t.className = "popup-title";
        t.textContent = label || "Ukjent navn";
        const s = document.createElement("div");
        s.className = "popup-sub";
        s.textContent = "Fileks-boks";
        el.append(t, s);

        popup = new mapboxgl.Popup({
          closeButton: IS_MOBILE,
          closeOnClick: false,
          offset: IS_MOBILE ? 36 : 30
        }).setLngLat(coords).setDOMContent(el).addTo(map);
      }

      // Desktop hover
      map.on("mouseenter", "unclustered-hit", (e) => {
        if (IS_MOBILE) return;
        map.getCanvas().style.cursor = "pointer";
        openPopupForFeature(e.features && e.features[0]);
      });
      map.on("mouseleave", "unclustered-hit", () => {
        if (IS_MOBILE) return;
        map.getCanvas().style.cursor = "";
        if (popup) popup.remove();
        popup = null;
      });

      // Mobil tap
      map.on("click", "unclustered-hit", (e) => {
        if (!IS_MOBILE) return;
        openPopupForFeature(e.features && e.features[0]);
      });
      map.on("click", (e) => {
        if (!IS_MOBILE) return;
        const feats = map.queryRenderedFeatures(e.point, { layers: ["unclustered-hit", "clusters"] });
        if (feats.length) return;
        if (popup) popup.remove();
        popup = null;
      });
    });
  </script>
</body>
</html>
